<script type="module">
  // استيراد Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC***********", // تأكد من وضع المفاتيح الصحيحة
    authDomain: "kr0wl-chat.firebaseapp.com",
    databaseURL: "https://kr0wl-chat-default-rtdb.firebaseio.com",
    projectId: "kr0wl-chat",
    storageBucket: "kr0wl-chat.appspot.com",
    messagingSenderId: "4342********",
    appId: "1:4342***********"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, "messages");

  const sendBtn = document.getElementById("send");
  const msgInput = document.getElementById("message");
  const chatBox = document.getElementById("chat");

  const username = sessionStorage.getItem("username") || "مجهول";

  sendBtn.addEventListener("click", () => {
    const text = msgInput.value.trim();
    if (text) {
      push(messagesRef, {
        name: username,
        text: text,
        timestamp: Date.now()
      });
      msgInput.value = "";
    }
  });

  // الاستماع للرسائل الجديدة تلقائيًا
  onChildAdded(messagesRef, (data) => {
    const msg = data.val();
    const msgElement = document.createElement("div");
    msgElement.innerHTML = `<strong style="color:#${stringToColor(msg.name)}">${msg.name}:</strong> ${msg.text}`;
    chatBox.appendChild(msgElement);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // تحويل الاسم إلى لون
  function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    return ((hash >> 24) & 0xFF).toString(16).padStart(2, "0") +
           ((hash >> 16) & 0xFF).toString(16).padStart(2, "0") +
           ((hash >> 8) & 0xFF).toString(16).padStart(2, "0");
  }
</script>
